<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>优雅导航</title>
  <!-- Google字体 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" />
  <!-- React与ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- react-beautiful-dnd -->
  <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #e0e7f5;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #a3bffa;
      border-radius: 3px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 text-gray-800">
  <div id="root"></div>
  <script type="text/babel">
    const {
      DragDropContext,
      Droppable,
      Draggable
    } = window.ReactBeautifulDnd;

    // 辅助：重新排序函数
    const reorder = (list, startIndex, endIndex) => {
      const result = Array.from(list);
      const [removed] = result.splice(startIndex, 1);
      result.splice(endIndex, 0, removed);
      return result;
    };

    // 改进的增强组件，包含天气和每日一句（使用 hitokoto 与 wttr.in）
    function ExtraWidgets() {
      const [time, setTime] = React.useState(new Date());
      const [quote, setQuote] = React.useState(null);
      const [weather, setWeather] = React.useState({ condition: '--', temp: '--' });
      
      // 实时更新时间
      React.useEffect(() => {
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);
      
      // 获取每日一句（hitokoto.cn接口）
      React.useEffect(() => {
        fetch("https://v1.hitokoto.cn/?encode=json")
          .then(res => res.json())
          .then(data => setQuote(data.hitokoto))
          .catch(err => {
            console.error("获取每日一句错误:", err);
            setQuote("保持微笑，生活总会有曙光。");
          });
      }, []);
      
      // 获取天气（以武汉为例，wttr.in支持JSON格式）  
      React.useEffect(() => {  
        fetch("https://wttr.in/Wuhan?format=j1")  
          .then(res => res.json())  
          .then(data => {  
            const current = data.current_condition[0];  
            setWeather({  
              condition: current.weatherDesc[0].value,  
              temp: current.temp_C  
            });  
          })  
          .catch(err => {  
            console.error("获取天气错误:", err);  
            setWeather({ condition: "晴", temp: "25" });  
          });  
      }, []);
      
      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
          <div className="p-4 bg-white/90 backdrop-blur-sm rounded-xl shadow text-center">
            <h3 className="text-xl font-semibold text-gray-700">当前时间</h3>
            <p className="mt-2 text-2xl font-mono">{time.toLocaleTimeString()}</p>
          </div>
          <div className="p-4 bg-white/90 backdrop-blur-sm rounded-xl shadow text-center">
            <h3 className="text-xl font-semibold text-gray-700">天气</h3>
            <p className="mt-2 text-2xl">{weather.condition} {weather.temp}°C</p>
          </div>
          <div className="p-4 bg-white/90 backdrop-blur-sm rounded-xl shadow text-center">
            <h3 className="text-xl font-semibold text-gray-700">每日一句</h3>
            <p className="mt-2 text-lg">{quote ? quote : "加载中..."}</p>
          </div>
        </div>
      );
    }

    function App() {
      const [categories, setCategories] = React.useState(() => {
        const saved = localStorage.getItem('navCategories');
        return saved ? JSON.parse(saved) : [];
      });
      const [newCategory, setNewCategory] = React.useState('');
      const [newLink, setNewLink] = React.useState({ title: '', url: '' });
      const [showAddCategory, setShowAddCategory] = React.useState(false);
      const [showAddLink, setShowAddLink] = React.useState(null);
      const [editingCategoryId, setEditingCategoryId] = React.useState(null);
      const [editingCategoryName, setEditingCategoryName] = React.useState('');
      const [managementMode, setManagementMode] = React.useState(false);
  
      const [searchQuery, setSearchQuery] = React.useState('');
      const [selectedEngine, setSelectedEngine] = React.useState('google');
      const searchEngines = {
        google: "https://www.google.com/search?q=",
        bing: "https://www.bing.com/search?q=",
        duckduckgo: "https://duckduckgo.com/?q="
      };

      // 搜索功能
      const handleSearch = () => {
        if (!searchQuery.trim()) return;
        const url = searchEngines[selectedEngine] + encodeURIComponent(searchQuery.trim());
        window.open(url, "_blank");
      };
  
      React.useEffect(() => {
        localStorage.setItem('navCategories', JSON.stringify(categories));
      }, [categories]);
  
      const handleAddCategory = () => {
        if (!newCategory.trim()) return;
        setCategories([
          ...categories,
          { id: Date.now().toString(), name: newCategory, links: [] }
        ]);
        setNewCategory('');
        setShowAddCategory(false);
      };
  
      const handleAddLink = (categoryId) => {
        if (!newLink.title.trim() || !newLink.url.trim()) return;
        setCategories(categories.map(category => {
          if (category.id === categoryId) {
            return {
              ...category,
              links: [...category.links, {
                id: Date.now().toString(),
                ...newLink,
                order: category.links.length
              }]
            };
          }
          return category;
        }));
        setNewLink({ title: '', url: '' });
        setShowAddLink(null);
      };

      const handleExport = () => {
        const dataStr = JSON.stringify(categories, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nav-config.json';
        a.click();
        URL.revokeObjectURL(url);
      };
  
      const handleImport = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              setCategories(imported);
            } catch (error) {
              console.error('导入失败:', error);
            }
          };
          reader.readAsText(file);
        }
      };
  
      const handleDeleteLink = (categoryId, linkId) => {
        setCategories(categories.map(category => {
          if (category.id === categoryId) {
            return { ...category, links: category.links.filter(link => link.id !== linkId) };
          }
          return category;
        }));
      };
  
      const handleDeleteCategory = (categoryId) => {
        setCategories(categories.filter(category => category.id !== categoryId));
      };
  
      const handleCategoryDoubleClick = (category) => {
        if (!managementMode) return;
        setEditingCategoryId(category.id);
        setEditingCategoryName(category.name);
      };
  
      const handleCategoryNameChange = (e) => {
        setEditingCategoryName(e.target.value);
      };
  
      const finishEditing = (categoryId) => {
        setCategories(categories.map(category => {
          if (category.id === categoryId) {
            return { ...category, name: editingCategoryName || category.name };
          }
          return category;
        }));
        setEditingCategoryId(null);
        setEditingCategoryName('');
      };
  
      const handleKeyDown = (e, categoryId) => {
        if (e.key === 'Enter') finishEditing(categoryId);
      };
  
      // 拖拽排序函数，仅在管理模式下启用
      const onDragEnd = (result) => {
        if (!result.destination) return;
        const reordered = reorder(categories, result.source.index, result.destination.index);
        setCategories(reordered);
      };
  
      const Icon = {
        Plus: () => (
          <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
            <path d="M12 5v14m-7-7h14" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        ),
        X: () => (
          <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
            <path d="M18 6L6 18M6 6l12 12" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        ),
        Download: () => (
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5l5 5 5-5m-5 5V3" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        ),
        Upload: () => (
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5l5-5 5 5m-5-5v12" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        ),
        Setting: () => (
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" >
            <circle cx="12" cy="12" r="3" />
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
        )
      };

      // 渲染分类列表，若管理模式启动则支持拖拽排序
      const renderCategories = () => {
        if (managementMode) {
          return (
          <DragDropContext onDragEnd={onDragEnd}>
            <Droppable droppableId="categories-droppable">
              {(provided) => (
                <div {...provided.droppableProps} ref={provided.innerRef} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {categories.map((category, index) => (
                    <Draggable key={category.id} draggableId={category.id} index={index}>
                      {(provided) => (
                        <div ref={provided.innerRef} {...provided.draggableProps} {...provided.dragHandleProps} className="bg-white/90 backdrop-blur-sm rounded-xl shadow p-6 fade-in">
                          <div className="flex justify-between items-center mb-4">
                            {editingCategoryId === category.id ?
                              <input
                                value={editingCategoryName}
                                onChange={handleCategoryNameChange}
                                onBlur={() => finishEditing(category.id)}
                                onKeyDown={(e) => handleKeyDown(e, category.id)}
                                autoFocus
                                className="text-2xl font-semibold text-gray-800 bg-transparent border-b border-blue-300 focus:outline-none"
                              />
                              :
                              <h2
                                className="text-2xl font-semibold text-gray-800 cursor-pointer hover:text-blue-600"
                                onDoubleClick={() => handleCategoryDoubleClick(category)}
                              >
                                {category.name}
                              </h2>
                            }
                            <button
                              onClick={() => handleDeleteCategory(category.id)}
                              className="p-2 bg-red-300 hover:bg-red-400 rounded transition"
                            >
                              <Icon.X />
                            </button>
                          </div>
                          <div className="space-y-3">
                            {category.links.map(link => (
                              <div key={link.id} className="flex items-center justify-between">
                                <a
                                  href={link.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="block py-2 px-4 rounded-md w-full bg-gray-50 hover:bg-gray-100 transition shadow-sm"
                                >
                                  {link.title}
                                </a>
                                <button
                                  onClick={() => handleDeleteLink(category.id, link.id)}
                                  className="ml-2 p-2 bg-red-300 hover:bg-red-400 rounded transition"
                                >
                                  <Icon.X />
                                </button>
                              </div>
                            ))}
                          </div>
                          <div className="mt-4">
                            <button
                              onClick={() => setShowAddLink(category.id)}
                              className="w-full px-4 py-2 bg-green-400 hover:bg-green-500 text-white rounded transition"
                            >
                              <Icon.Plus /> 添加链接
                            </button>
                          </div>
                        </div>
                      )}
                    </Draggable>
                  ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>
          </DragDropContext>
          );
        } else {
          return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {categories.map(category => (
                <div key={category.id} className="bg-white/90 backdrop-blur-sm rounded-xl shadow p-6 fade-in">
                  <div className="flex justify-between items-center mb-4">
                    {editingCategoryId === category.id ?
                      <input
                        value={editingCategoryName}
                        onChange={handleCategoryNameChange}
                        onBlur={() => finishEditing(category.id)}
                        onKeyDown={(e) => handleKeyDown(e, category.id)}
                        autoFocus
                        className="text-2xl font-semibold text-gray-800 bg-transparent border-b border-blue-300 focus:outline-none"
                      />
                      :
                      <h2
                        className="text-2xl font-semibold text-gray-800"
                        onDoubleClick={() => handleCategoryDoubleClick(category)}
                      >
                        {category.name}
                      </h2>
                    }
                    {managementMode && (
                      <button
                        onClick={() => handleDeleteCategory(category.id)}
                        className="p-2 bg-red-300 hover:bg-red-400 rounded transition"
                      >
                        <Icon.X />
                      </button>
                    )}
                  </div>
                  <div className="space-y-3">
                    {category.links.map(link => (
                      <div key={link.id} className="flex items-center justify-between">
                        <a
                          href={link.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block py-2 px-4 rounded-md w-full bg-gray-50 hover:bg-gray-100 transition shadow-sm"
                        >
                          {link.title}
                        </a>
                        {managementMode && (
                          <button
                            onClick={() => handleDeleteLink(category.id, link.id)}
                            className="ml-2 p-2 bg-red-300 hover:bg-red-400 rounded transition"
                          >
                            <Icon.X />
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          );
        }
      };

      return (
        <div className="min-h-screen py-8 px-4">
          <div className="max-w-6xl mx-auto">
            <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8">
              <h1 className="text-5xl font-light mb-4 sm:mb-0 bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-green-300">
                优雅导航
              </h1>
              <div className="flex items-center gap-4">
                <button
                  onClick={() => setManagementMode(!managementMode)}
                  className="flex items-center gap-1 px-3 py-2 bg-green-200 hover:bg-green-300 rounded-md text-gray-700 transition"
                >
                  <Icon.Setting />
                  <span>{managementMode ? "退出管理" : "进入管理"}</span>
                </button>
                <button
                  className="p-3 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full shadow hover:shadow-lg transition"
                  onClick={() => document.getElementById('import-input').click()}
                >
                  <Icon.Upload />
                </button>
                <button
                  className="p-3 bg-gradient-to-r from-purple-400 to-pink-500 rounded-full shadow hover:shadow-lg transition"
                  onClick={handleExport}
                >
                  <Icon.Download />
                </button>
                <input id="import-input" type="file" accept=".json" className="hidden" onChange={handleImport} />
              </div>
            </div>
  
            <ExtraWidgets />
  
            <div className="mb-8 bg-white/90 backdrop-blur-sm p-6 rounded-xl shadow flex flex-wrap items-center gap-3">
              <select
                value={selectedEngine}
                onChange={(e) => setSelectedEngine(e.target.value)}
                className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300"
              >
                <option value="google">Google</option>
                <option value="bing">Bing</option>
                <option value="duckduckgo">DuckDuckGo</option>
              </select>
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="输入搜索关键词"
                className="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300"
              />
              <button
                onClick={handleSearch}
                className="px-6 py-2 bg-gradient-to-r from-blue-400 to-green-400 text-white rounded-md hover:from-blue-500 hover:to-green-500 transition-colors"
              >
                搜索
              </button>
            </div>
  
            {managementMode && (
              <div className="mb-6">
                <button
                  className="px-4 py-2 bg-blue-400 text-white rounded-md hover:bg-blue-500 transition"
                  onClick={() => setShowAddCategory(true)}
                >
                  + 新建分类
                </button>
              </div>
            )}
  
            {renderCategories()}
          </div>
  
          {showAddCategory && managementMode && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl p-8 w-80 shadow-lg fade-in">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-2xl font-medium text-gray-700">创建新分类</h3>
                  <button onClick={() => setShowAddCategory(false)} className="p-1 hover:bg-gray-100 rounded">
                    <Icon.X />
                  </button>
                </div>
                <div className="flex gap-3">
                  <input
                    type="text"
                    value={newCategory}
                    onChange={(e) => setNewCategory(e.target.value)}
                    placeholder="输入分类名称"
                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300"
                  />
                  <button
                    onClick={handleAddCategory}
                    className="px-4 py-2 bg-blue-400 text-white rounded-md hover:bg-blue-500 transition"
                  >
                    创建
                  </button>
                </div>
              </div>
            </div>
          )}
  
          {showAddLink && managementMode && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl p-8 w-80 shadow-lg fade-in">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-2xl font-medium text-gray-700">添加新链接</h3>
                  <button onClick={() => setShowAddLink(null)} className="p-1 hover:bg-gray-100 rounded">
                    <Icon.X />
                  </button>
                </div>
                <div className="space-y-4">
                  <input
                    type="text"
                    value={newLink.title}
                    onChange={(e) => setNewLink({ ...newLink, title: e.target.value })}
                    placeholder="链接标题"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300"
                  />
                  <input
                    type="text"
                    value={newLink.url}
                    onChange={(e) => setNewLink({ ...newLink, url: e.target.value })}
                    placeholder="链接 URL"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-300"
                  />
                  <button
                    onClick={() => handleAddLink(showAddLink)}
                    className="w-full px-4 py-2 bg-green-400 text-white rounded-md hover:bg-green-500 transition"
                  >
                    添加
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
  
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  <script>
    window.parent.postMessage({ action: "ready" }, "*");
    window.console = new Proxy(console, {
      get(target, prop) {
        if (['log', 'warn', 'error'].includes(prop)) {
          return new Proxy(target[prop], {
            apply(fn, thisArg, args) {
              fn.apply(thisArg, args);
              window.parent.postMessage({
                action: 'console',
                type: prop,
                args: args.map(arg => {
                  try { return JSON.stringify(arg).replace(/^["']|["']$/g, ''); }
                  catch (e) { return arg; }
                })
              }, '*');
            }
          });
        }
        return target[prop];
      }
    });
  </script>
</body>
</html>
